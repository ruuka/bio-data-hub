<template>
  <div ref="plotlyDiv"></div>
</template>

<script>
let Plotly
if (process.client) {
  Plotly = require('@/plugins/plotly.client')
}
export default {
  name: 'NewBoxPlot',
  props: {
    plotTitle: {
      type: String,
      default: '',
    },
    yAxisTitle: {
      type: String,
      default: '',
    },
    boxPlotData: {
      type: Array,
      required: true,
    },
  },
  data() {
    return {
      response: [
        {
          // Example study for age group response to drug ( label/API endpoint -> request -> response)
          name: '0 - 18 years old',
          dataPoints: [
            {
              type: 'Placebo',
              y: [0],
            },
            {
              type: 'Filgotinib, 200mg',
              y: [0],
            },
          ],
        },
        {
          name: '19 - 35 years old',
          dataPoints: [
            {
              type: 'Placebo',
              y: [
                2.95307, 4.77045, 4.61497, 5.81543, 7.33779, 3.59832, 2.98354,
                2.03284, 3.37654, 1.87842, 2.92053, 4.93917, 2.76682, 5.27131,
                4.16974, 1.16454, 1.82581, 3.13466, 3.95418, 2.74762, 5.06493,
                3.27787, 4.02691, 6.22014, 9.5273, 10.1564, 7.05472, 4.47838,
                7.25635, 7.42049, 4.03857, 6.14701, 6.61189, 1.83152,
              ],
            },
            {
              type: 'Filgotinib, 200 mg',
              y: [
                6.15075, 2.35603, 4.80642, 2.55613, 4.98903, 3.85371, 4.14275,
                2.7298, 5.15144, 7.53895, 6.04689, 5.95161, 6.96308, 6.57906,
                6.32973, 4.25014, 3.94973, 3.70576, 1.98266, 2.95307, 4.77045,
                4.12987, 7.85005, 4.61497, 6.38568, 3.26376, 7.82907, 5.81543,
                6.04408, 5.62856, 5.17458, 3.89775, 7.33779, 4.15198, 3.59832,
                2.98354, 3.825, 2.03284, 2.94377, 3.37654, 3.81161, 2.38393,
                1.87842, 2.92053, 2.44554, 8.31602, 8.91667, 8.41302, 4.93917,
                8.34272, 7.89443, 2.76682, 5.27131, 4.16974, 4.74042, 4.83943,
                2.89407, 4.77295, 3.23641, 1.16454, 4.34573, 5.66646, 1.82581,
                3.92367, 2.74795, 5.08844, 10.0884, 3.13466, 7.09858, 3.95418,
                9.74775, 2.74762, 5.06493, 2.67345, 1.66748, 6.6047, 4.95317,
                3.05006, 6.2318, 7.02581, 4.95149, 2.66437, 3.63633, 5.34566,
                3.27787, 4.02691, 4.88907, 6.22014, 3.83682, 9.5273, 10.1564,
                5.479, 7.05472, 4.24874, 3.02554, 4.42365, 3.13821, 2.87764,
                2.64212, 6.78336, 4.47838, 4.56738, 2.74258, 7.31475, 7.25635,
                7.42049, 7.19894, 2.16775, 3.75332, 7.24866, 5.89991, 4.84118,
                4.03857, 6.14701, 6.61189, 5.40742, 1.83152,
              ],
            },
          ],
        },
        {
          name: '36 - 55 years old',
          dataPoints: [
            {
              type: 'Placebo',
              y: [
                4.39659, 4.156, 3.83673, 4.83303, 8.6961, 4.67279, 2.45811,
                5.31789, 7.88282, 9.81033, 6.73803, 3.36132, 5.23898, 6.51785,
                5.46276, 7.7831, 5.8735, 8.34304, 8.34669, 3.23123, 2.03367,
                4.84356, 6.36292, 3.97783, 3.278, 5.52008, 4.59353, 4.74178,
                3.46242, 7.72684, 11.8958, 11.3009, 4.87368, 8.49569, 4.03807,
                7.56889, 3.87737, 4.90278, 8.19426, 6.53225, 7.61697, 5.00476,
                4.08249, 8.38884, 3.06188, 13.5124, 5.51493, 4.78112, 11.9829,
                5.38508, 8.39913, 2.46584, 12.595, 7.60104, 5.53782, 4.74418,
                5.01469, 6.84628, 5.08057, 4.82658, 5.09652, 9.7472, 5.35271,
                3.07164, 4.89692, 3.42663, 2.8, 4.92948, 2.06915, 3.70857,
                3.04836, 3.08941, 2.08842, 2.80685, 2.00819, 1.96129, 7.71436,
                5.53912, 2.43732, 4.45251, 5.82246, 5.12659, 6.01954, 3.5601,
                8.23435, 3.86882, 12.2388, 9.56971, 2.79031, 5.89582, 6.22645,
                4.7072, 4.77864, 8.75544, 2.76054, 4.69813, 5.16431, 6.71589,
                6.73546, 6.352, 7.0238, 2.76991, 5.7084, 5.61988, 8.56641,
                10.851, 4.83956, 7.37055, 4.18798, 7.66191, 12.2486, 8.23187,
                4.58422, 15.2522, 3.73902, 4.6444, 2.68827, 3.15478, 4.93377,
                3.29862, 2.42645, 3.30946, 6.45364, 2.2861, 5.16381, 3.2332,
                5.95448, 4.23336, 3.18821, 3.81327, 5.75553, 4.3318, 5.03957,
                4.13437, 4.60624, 5.46418, 4.39348, 3.89195, 3.04535, 4.21907,
                5.61566, 6.71617, 3.7958, 3.89185, 8.04667, 4.50322, 5.84839,
                7.2022, 7.47923, 8.96005, 2.87153, 4.23682, 4.1383, 5.9727,
                8.30856, 5.50671, 4.02081, 4.88553, 2.88641, 5.51139, 5.15102,
                4.99962, 6.49662, 4.15854,
              ],
            },
            {
              type: 'Filgotinib, 200 mg',
              y: [
                4.39659, 4.156, 4.89973, 4.48602, 3.11795, 3.8651, 3.83673,
                4.83303, 8.6961, 7.1628, 7.73295, 4.67279, 5.69221, 2.45811,
                5.31789, 7.88282, 9.81033, 6.73803, 7.14704, 8.52127, 3.36132,
                5.23898, 6.51785, 4.78235, 5.46276, 7.56948, 7.7831, 5.8735,
                6.99481, 5.90481, 8.34304, 4.78329, 8.34669, 10.3399, 3.23123,
                12.4975, 2.03367, 15.5078, 12.7318, 4.84356, 12.2707, 6.36292,
                3.97783, 3.61837, 6.5981, 3.278, 5.52008, 4.59353, 4.74178,
                3.46242, 7.72684, 3.93831, 11.8958, 11.3009, 6.71602, 4.87368,
                5.7468, 8.49569, 3.22782, 1.48444, 2.77263, 3.42441, 4.03807,
                6.14756, 10.6013, 7.56889, 3.87737, 7.71018, 4.90278, 8.19426,
                7.92811, 6.53225, 8.25622, 9.79914, 7.61697, 5.00476, 4.08249,
                8.38884, 4.48164, 3.06188, 10.043, 13.5124, 5.51493, 4.78112,
                11.9829, 5.38508, 8.39913, 2.46584, 12.595, 5.16274, 7.60104,
                5.53782, 4.74418, 5.01469, 6.84628, 6.19537, 6.98888, 5.08057,
                4.82658, 5.09652, 9.7472, 5.35271, 11.1913, 3.07164, 4.89692,
                1.91011, 2.25902, 3.42663, 2.8, 4.92948, 2.06915, 3.70857,
                3.04836, 3.08941, 2.08842, 2.80685, 2.69647, 3.20184, 9.1228,
                2.00819, 1.96129, 5.12219, 7.71436, 6.57092, 5.61179, 6.71628,
                5.53912, 2.43732, 3.50539, 3.40028, 4.45251, 5.82246, 8.33485,
                5.12659, 6.01954, 3.5601, 6.92843, 9.92828, 8.23435, 12.1557,
                3.86882, 12.2388, 5.78269, 9.56971, 2.79031, 5.89582, 6.22645,
                4.7072, 6.8612, 4.77864, 8.75544, 2.76054, 4.69813, 5.16431,
                6.71589, 6.73546, 6.12298, 2.42022, 1.62448, 6.352, 5.13146,
                3.01063, 7.0238, 2.76991, 4.07641, 5.7084, 3.35456, 4.52072,
                2.69941, 5.61988, 5.87918, 8.56641, 6.0176, 10.851, 3.99472,
                4.83956, 3.61353, 7.57084, 7.37055, 4.18798, 7.66191, 12.2486,
                5.7563, 3.38638, 8.23187, 6.07098, 4.58422, 15.2522, 4.96375,
                3.35431, 3.73902, 4.6444, 2.68827, 3.15478, 4.93377, 3.29862,
                2.42645, 3.30946, 6.45364, 4.52284, 3.96366, 2.2861, 2.90525,
                5.16381, 5.32313, 3.42576, 2.3128, 4.13748, 1.82567, 4.41155,
                4.80173, 7.7958, 3.59581, 4.34678, 3.30423, 6.29535, 3.2332,
                5.95448, 4.23336, 3.18821, 12.8637, 3.92751, 3.81327, 5.75553,
                4.3318, 4.55227, 5.1158, 5.03957, 4.13437, 4.60624, 5.46418,
                3.32383, 1.89494, 3.6093, 6.51608, 4.39348, 3.89195, 3.04535,
                4.21907, 5.61566, 6.71617, 3.7958, 3.89185, 11.2042, 6.06625,
                7.91716, 16.3281, 13.4861, 8.58206, 8.04667, 4.50322, 5.84839,
                7.2022, 7.47923, 8.96005, 2.87153, 4.23682, 4.1383, 5.9727,
                8.30856, 5.50671, 4.02081, 2.00096, 4.88553, 2.88641, 5.51139,
                4.37489, 5.15102, 6.03245, 6.57905, 9.31774, 2.46049, 4.99962,
                6.34515, 6.49662, 4.15854,
              ],
            },
          ],
        },
        {
          name: '56+ years old',
          dataPoints: [
            {
              type: 'Placebo',
              y: [11.7657, 9.04441, 8.55643, 9.06309, 7.14204],
            },
            {
              type: 'Filgotinib, 200 mg',
              y: [
                3.00642, 6.08451, 3.82403, 5.84096, 4.71173, 5.46287, 4.76654,
                3.13185, 3.04077, 11.7657, 9.04441, 2.95113, 5.55378, 4.40496,
                6.30866, 5.12036, 8.55643, 9.06309, 2.60774, 3.16456, 7.14204,
              ],
            },
          ],
        },
      ],
    }
  },
  computed: {
    plotData() {
var formatted  = [];
for (let i=0; i< this.boxPlotData.length; i++) {

  if(this.checkPresent(formatted,this.boxPlotData[i].primaryGroup) == -1 ) {

     const dataItem = {
       name : this.boxPlotData[i].primaryGroup,
       dataPoints: [{
         type:this.boxPlotData[i].secondaryGroup,
         y:this.boxPlotData[i].values
       }]
     }
    formatted.push(dataItem);
  }else {
    const indx = this.checkPresent(formatted,this.boxPlotData[i].primaryGroup);

     formatted[indx].dataPoints.push({
         type:this.boxPlotData[i].secondaryGroup,
         y:this.boxPlotData[i].values
       });




  }
}
return formatted;

    },
  },
    watch: {
        boxPlotData: {
            handler: function(newValue) {
              this.reTraceDataForPlot()
              console.log("retracing when chart data changes");
            },
            deep: true
        }
    },
  mounted() {
    this.plotData
    this.reTraceDataForPlot()
  },
  methods: {
    checkPresent(formatted, name)  {
      return formatted.findIndex(item => item.name === name);
    },
    reTraceDataForPlot() {
      const colors = ['#C51F3F', '#F4992E', '#6DC981', '#36BCE7']

      const x = []

      for (let i = 0; i < this.plotData.length; i++) {
        let xName = this.plotData[i].name

        for (
          let j = 0;
          j < this.plotData.length * this.plotData[i].dataPoints.length;
          j++
        ) {
          x.push(xName)
        }
      }

      const result = []
      const traceOptions = {
        type: 'box',
        boxpoints: 'all',
        jitter: 0.3,
        pointpos: 0,
      }

      this.plotData.forEach((dataGroup, i) => {
        dataGroup.dataPoints.forEach((individualDataSet) => {
          const xArray = []
          individualDataSet.y.forEach(() => xArray.push(dataGroup.name))
          result.push({
            marker: { color: colors[i % colors.length] },
            name: individualDataSet.type,
            y: individualDataSet.y,
            x: xArray,
            ...traceOptions,
          })
        })
      })
      console.log('Trace Results', result)

      const config = {
        responsive: true,
        displaylogo: false,
        modeBarButtonsToRemove: [
          'sendDataToCloud',
          'zoom2d',
          'toggleSpikelines',
          'hoverCompareCartesian',
          'select2d',
          'pan2d',
          'zoomIn2d',
          'zoomOut2d',
          'hoverClosestCartesian',
          'autoScale2d',
          'lasso2d',
        ],
      }
      const layout = {
        showlegend: true,
        title: {
          text: this.$props.plotTitle,
        },
        xaxis: {
          title: this.$props.xAxisTitle,
          // showgrid: false,
          // zeroline: false,
          // tickangle: 60,
          // showticklabels: false
        },
        yaxis: {
          title: this.$props.yAxisTitle,
          // type: this.$props.plotSetup.axisScale,
          zeroline: false,
          //autorange: true,
          //showgrid: true,
          //dtick: 5,
          //gridcolor: 'rgb(255, 255, 255)',
          //gridwidth: 1,
          //zerolinecolor: 'rgb(255, 255, 255)',
          //zerolinewidth: 2
        },
        //boxmode: 'group',
        //margin: { t: 25, b: 150, l: 50, r: 15 },
      }
      if (this.$props.plotTitle > 50) {
        layout.titlefont = { size: 12 }
      }
      Plotly.newPlot(this.$refs.plotlyDiv, result, layout, config)
    },
  },
}
</script>
